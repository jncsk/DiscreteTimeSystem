# 行列指数関数の数値解析 -アルゴリズム編-

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [行列指数関数の数値解析 -アルゴリズム編-](#行列指数関数の数値解析--アルゴリズム編-)
  - [0. 初めに](#0-初めに)
  - [1. 行列指数関数におけるPade近似式](#1-行列指数関数におけるpade近似式)
  - [2. MATLAB/Higham 実装の係数 $b_j$](#2-matlabhigham-実装の係数-b_j)
  - [3. なぜこんなスケーリングをするのか](#3-なぜこんなスケーリングをするのか)
  - [4. まとめると](#4-まとめると)

<!-- /code_chunk_output -->

---
## 0. 初めに
本章では、行列指数関数の数値解析手法をアルゴリズム面から解説する。

---
## 1. 行列指数関数におけるPade近似式

行列指数関数の Padé 近似は次の形で表される。

\[
R_m(x) = \frac{P_m(x)}{Q_m(x)} = (V_m + U_m)(V_m - U_m)^{-1}
\]

ここで
- **\( V_m \)** : 偶数次の項（係数 \( c_{2j}^{(m)} \)）
  \[
  V_m = c_0^{(m)}I + c_2^{(m)}A^2 + c_4^{(m)}A^4 + \dots
  \]
- **\( U_m \)** : 奇数次の項（係数 \( c_{2j+1}^{(m)} \)）
  \[
  U_m = c_1^{(m)}A + c_3^{(m)}A^3 + \dots
  \]

Padé 近似の係数 \( c_j^{(m)} \) は次式で与えられる。
\[
c_j^{(m)} = \frac{(2m-j)!\, m!}{(2m)!\, j!\, (m-j)!}, \quad j=0,1,\dots,m
\]

この係数を用いると
\[
P_m(x) = \sum_{j=0}^m c_j^{(m)}\, x^j, \quad
Q_m(x) = \sum_{j=0}^m c_j^{(m)}\, (-x)^j
\]
となり、偶数次と奇数次で符号が反転する構造が自動的に得られる。

---

## 2. MATLAB/Higham 実装の係数 $b_j$

MATLAB や Higham の実装では、係数の表現を

$$
P_m(x) = \sum_{j=0}^m b_j\,x^j
$$

としていて、このときの $b_j$ は

$$
b_j = c_j^{(m)} \cdot \frac{(2m)!}{m!}
$$

になっています。

このスケール因子 $\frac{(2m)!}{m!}$ は、**分母と分子の両方に同じ定数倍を掛けた**だけです。
有理関数 $R_m(x) = P_m(x)/Q_m(x)$ の値は、分子と分母に同じ定数倍をしても変わらないので、近似自体は同じです。

---

## 3. なぜこんなスケーリングをするのか

実装的な理由は次の通りです。

* **整数係数にできる**
  このスケーリングをすると $b_j$ がきれいな整数になります（120, 60, 12, ... のように）。
  これなら事前に定数としてハードコードしやすく、丸め誤差も少なく済みます。
* **冪乗計算での安定性改善**
  $b_j$ が極端に小さい値や分数だと、行列累乗の加算時に桁落ちしやすいですが、大きめの整数にしておくと相対誤差が減ります。
* **古い Fortran 実装との互換性**
  Higham の `expm` 実装や古い文献では、この整数形式がよく使われています。

---

## 4. まとめると

* $c_j^{(m)}$ … 理論導出時に自然に出てくる係数（$c_0=1$ の正規化）
* $b_j$ … 実装上扱いやすくするために $\frac{(2m)!}{m!}$ 倍した係数（整数化）
* 両者の近似式は**全く同じ**（分子・分母を同じ定数倍しているだけ）


---

内部専用（.c ファイルに閉じ込める）

build_even_powers(...)
→ A², A⁴, … の必要分を作る

free_even_powers(...)
→ それらを解放する

max_even_power_for_m(...)
→ m に応じて必要な最大偶数乗を返す

build_UV_with_powers(...)
→ 既に構築済みの偶数乗を使って U, V を構築する

---

## 5. 実装メモ

ライブラリ関数 `matrix_exp_exponential` は入力行列 `A` をスカラー `t` で
スケーリングした後、ここで説明したスケーリング&スクエアリング付きの
Padé 近似 (`pade_expm`) を用いて \(e^{tA}\) を計算する。
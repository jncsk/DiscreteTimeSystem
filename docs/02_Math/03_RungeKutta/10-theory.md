# Runge-Kutta method 

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [Runge-Kutta method](#runge-kutta-method)
  - [0. 初めに](#0-初めに)
  - [1. 問題設定](#1-問題設定)
  - [2. Runge-Kutta法](#2-runge-kutta法)
    - [2.1 オイラー法（Euler method）](#21-オイラー法euler-method)
    - [2.2 古典的4次Runge-Kutta法](#22-古典的4次runge-kutta法)
    - [2.3 オイラー法とRunge-Kutta法の比較](#23-オイラー法とrunge-kutta法の比較)
    - [2.4 Runge-Kutta法の係数の求め方](#24-runge-kutta法の係数の求め方)
    - [2.5 Runge-Kutta法の一般形と特殊ケース](#25-runge-kutta法の一般形と特殊ケース)
      - [特殊ケース一覧](#特殊ケース一覧)
  - [3. まとめ](#3-まとめ)

<!-- /code_chunk_output -->

---

## 0. 初めに
本章では、微分方程式の数値解析手法として広く用いられる **Runge-Kutta法** を理論面から解説する。

---

## 1. 問題設定
以下の状態方程式を考える。

$$
\begin{equation}
\dot{x}(t) = f(x(t), u(t), t)
\end{equation}
$$

このとき、$f$ が線形か非線形かによって数値解析の扱いは大きく異なる。

- **線形の場合**（例：$f(x,u,t)=Ax+Bu$）、行列指数関数 $e^{At}$ に基づく**閉形式解**が存在し、これを数値的に評価する方法として **Padé近似法** や **Krylov部分空間法** が用いられる。
- **非線形の場合**、一般に閉形式解は存在せず、数値積分により近似解を求める必要がある。その代表的な方法が **Runge-Kutta法** である。

| 方程式       | 解法の特徴 |
| ------------ | ----------------------------- |
| 線形方程式   | $e^{At}$ を利用（Padé近似, Krylov法など） |
| 非線形方程式 | 厳密解は一般に存在せず、数値解法（Runge-Kutta法など）を用いる |

> **Note**: ここでいう「厳密解」とは **閉形式解 (closed-form solution)** を指す。  
> 閉形式解とは、指数関数・三角関数・対数などの基本的な関数の有限な組み合わせで表される解である。  
> 例：$\dot{x}(t)=ax(t)$ の解 $x(t)=x_0 e^{at}$ は閉形式解。  
> 一方で、非線形方程式の多くは閉形式解を持たず、その場合は **特殊関数**（例：Airy関数）や **無限級数展開** によって表されることが多い。

---

## 2. Runge-Kutta法

前節で述べたように、非線形方程式は一般に閉形式解を持たず、数値的に近似解を求める必要がある。  
その代表的な手法のひとつが **Runge-Kutta法** である。

---

### 2.1 オイラー法（Euler method）

Runge-Kutta法を理解する前に、最も基本的な数値解法である **オイラー法** を確認する。  
オイラー法は「現在位置での傾き（変化率）をそのまま用いて、次の点を直線的に予測する」手法である。

状態方程式

$$
\begin{equation}
\dot{x}(t) = f(x(t), u(t), t)
\end{equation}
$$

に対して、刻み幅を $h$ とすると更新式は次のようになる。

$$
\begin{equation}
x_{k+1} = x_k + h f(x_k, u_k, t_k)
\end{equation}
$$

**アルゴリズム手順**
1. **状態の取得**  
   前のステップで求めた状態 $x_k$ を準備する。
2. **傾きの計算**  
   $f(x_k, u_k, t_k)$ をそのまま計算し、$\dot{x}(t_k)$ の値を得る。
3. **次状態の更新**  
   $x_{k+1} = x_k + h f(x_k, u_k, t_k)$ を計算し、次の状態を求める。

**イメージ**
- 「現在の傾きを一定と仮定して $h$ 秒だけ進める」＝**直線近似**。  
- 実装が簡単だが、精度は一次（誤差 $\mathcal{O}(h)$）に留まる。

> **Note**: オイラー法は計算が軽量である反面、ステップ幅 $h$ を大きくすると誤差が急速に増える。  
> Runge-Kutta法はこの弱点を克服するために考案された改良版である。

---

### 2.2 古典的4次Runge-Kutta法

刻み幅を $h$ とするとき、次の計算を行う。

$$
\begin{equation}
\begin{aligned}
k_1 &= f(x_k, u_k, t_k) \\
k_2 &= f\!\left(x_k + \tfrac{h}{2}k_1,\; u_{k+\tfrac{1}{2}},\; t_k + \tfrac{h}{2}\right) \\
k_3 &= f\!\left(x_k + \tfrac{h}{2}k_2,\; u_{k+\tfrac{1}{2}},\; t_k + \tfrac{h}{2}\right) \\
k_4 &= f(x_k + h k_3,\; u_{k+1},\; t_k + h) \\
\end{aligned}
\end{equation}
$$

次の状態は

$$
\begin{equation}
x_{k+1} = x_k + \frac{h}{6}(k_1 + 2k_2 + 2k_3 + k_4)
\end{equation}
$$

で与えられる。  

---

### 2.3 オイラー法とRunge-Kutta法の比較

オイラー法は次のように表される。

$$
\begin{equation}
x_{k+1} = x_k + h f(x_k, u_k, t_k)
\end{equation}
$$

これは「区間 $[t_k, t_k+h]$ の傾きがずっと一定である」と仮定して直線的に進める手法である。  
しかし実際には傾きは時間とともに変化するため、精度は一次（誤差 $\mathcal{O}(h)$）にとどまる。

一方、Runge-Kutta法は区間内の複数点で傾きを評価し、それらを加重平均することで高次精度を実現する。  
例えばRK4では以下の4点で傾きを計算する：

- $k_1$: 始点の傾き  
- $k_2$: 中点の傾き（$k_1$ に基づく予測点）  
- $k_3$: もう一度中点の傾き（$k_2$ に基づく予測点）  
- $k_4$: 終点の傾き  

次の状態は

$$
\begin{equation}
x_{k+1} = x_k + \frac{h}{6}(k_1 + 2k_2 + 2k_3 + k_4)
\end{equation}
$$

で与えられる。  
これは「始点・中点・終点の傾きを $1:2:2:1$ の比率で平均したもの」と解釈できる。

![Euler vs RK4](euler_vs_rk4.png)

この図のように、オイラー法は始点の傾きに依存するため誤差が大きいが、RK4は区間全体の傾きをバランスよく反映するため真の解に近い。

---

### 2.4 Runge-Kutta法の係数の求め方

Runge-Kutta法の基本アイデアは、**テイラー展開に基づく近似**である。  
刻み幅 $h$ で次の時刻に進めるとき、厳密解は

$$
\begin{equation}
x(t_k+h) = x(t_k) + h x'(t_k) + \frac{h^2}{2} x''(t_k) + \frac{h^3}{6} x^{(3)}(t_k) + \frac{h^4}{24} x^{(4)}(t_k) + \mathcal{O}(h^5)
\end{equation}
$$

と展開される。  
この式を直接利用するには高階導関数 $x''(t), x^{(3)}(t), \dots$ が必要だが、実際には求めにくい。  
そこで **関数の評価を複数点で行い、それを加重平均することで高次精度を実現する**のがRunge-Kutta法である。

---

### 2.5 Runge-Kutta法の一般形と特殊ケース

Runge-Kutta法は、係数 $a_{ij}, b_i, c_i$ を適切に選ぶことで様々な数値解法を表現できる。  
一般形は次のとおりである。

$$
\begin{equation}
\begin{aligned}
k_i &= f\!\left(x_k + h \sum_{j=1}^{i-1} a_{ij} k_j,\; t_k + c_i h \right), \quad i=1,2,\dots,s \\
x_{k+1} &= x_k + h \sum_{i=1}^{s} b_i k_i
\end{aligned}
\end{equation}
$$

---

#### 特殊ケース一覧

| 手法名 | ステージ数 $s$ | $a_{ij}$ | $b_i$ | $c_i$ | 更新式の特徴 |
|--------|---------------|----------|-------|-------|--------------|
| **オイラー法** (Euler) | 1 | なし | $b_1=1$ | $c_1=0$ | $x_{k+1}=x_k+h f(x_k,t_k)$ |
| **中点法** (RK2, Midpoint) | 2 | $a_{21}=\tfrac{1}{2}$ | $b_1=0, b_2=1$ | $c_2=\tfrac{1}{2}$ | 中点での傾きを利用 |
| **Heun法** (修正オイラー) | 2 | $a_{21}=1$ | $b_1=\tfrac{1}{2}, b_2=\tfrac{1}{2}$ | $c_2=1$ | 始点と終点の傾きの平均 |
| **古典的RK4** | 4 | $a_{21}=\tfrac{1}{2}, a_{32}=\tfrac{1}{2}, a_{43}=1$ | $b_1=\tfrac{1}{6}, b_2=\tfrac{1}{3}, b_3=\tfrac{1}{3}, b_4=\tfrac{1}{6}$ | $c_2=\tfrac{1}{2}, c_3=\tfrac{1}{2}, c_4=1$ | 始点・中点・終点をバランスよく平均 |

---

## 3. まとめ

本章では、非線形微分方程式に対して広く用いられる数値解法である **Runge-Kutta法**、特に古典的4次法（RK4）について解説した。  
オイラー法から出発し、テイラー展開との比較によって係数が導かれること、そしてブッチャー表で一般化できることを確認した。  

RK4は「実装が容易」「精度と計算コストのバランスが良い」という特徴から、制御工学や数値シミュレーションの分野で最も標準的に用いられる手法のひとつである。  
